<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正在播放 - 4K影院</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .player-container { padding-top: 80px; width: 100%; aspect-ratio: 16/9; background: #000; }
        iframe { width: 100%; height: 100%; border: none; }
        .detail-info { padding: 30px 5%; display: flex; gap: 40px; }
        .detail-poster { width: 240px; border-radius: 12px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .res-list { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .res-item { padding: 8px 20px; border: 1px solid var(--accent-color); border-radius: 4px; cursor: pointer; transition: var(--transition); }
        .res-item.active { background: var(--accent-color); color: black; font-weight: bold; }
        .tag { background: #333; padding: 2px 10px; border-radius: 4px; font-size: 12px; margin-right: 10px; color: var(--accent-color); }
    </style>
</head>
<body>
    <div id="app">
        <nav class="navbar">
            <a href="index.html" class="logo">4K<span>MOVIE</span></a>
        </nav>

        <!-- 播放器区域 -->
        <div class="player-container" v-if="currentSource">
            <iframe :src="currentSource.playUrl" allowfullscreen></iframe>
        </div>

        <!-- 详情区域 -->
        <div class="detail-info" v-if="movie">
            <img :src="movie.coverUrl" class="detail-poster">
            <div style="flex: 1;">
                <h1 style="font-size: 36px; margin-bottom: 10px;">{{ movie.title }}</h1>
                <div style="margin-bottom: 20px;">
                    <span class="tag" v-for="t in (movie.tags ? movie.tags.split(',') : [])">{{ t }}</span>
                    <span style="color: var(--text-muted)">{{ movie.releaseYear }} · {{ movie.country }} · {{ movie.language }}</span>
                </div>
                <p style="color: #ccc; line-height: 1.8; margin-bottom: 30px;">{{ movie.description }}</p>
                
                <h3>选择播放线路</h3>
                <div class="res-list">
                    <div class="res-item" 
                         v-for="r in resources" 
                         :class="{active: currentSource && currentSource.id === r.id}"
                         @click="currentSource = r">
                        {{ r.sourceName }} [{{ r.quality }}]
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, onBeforeUnmount } = Vue;
        createApp({
            setup() {
                const movie = ref(null);
                const resources = ref([]);
                const currentSource = ref(null);
                let progressInterval = null;

                const loadData = async () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const id = urlParams.get('id');
                    if (!id) return;

                    const res = await axios.get(`/api/movies/${id}`);
                    movie.value = res.data.info;
                    resources.value = res.data.resources;
                    if (resources.value.length > 0) currentSource.value = resources.value[0];

                    // 启动进度保存定时器 (模拟观影进度，每10秒保存一次)
                    let seconds = 0;
                    progressInterval = setInterval(() => {
                        seconds += 10;
                        axios.post(`/api/movies/history?movieId=${id}&seconds=${seconds}`);
                    }, 10000);
                };

                onMounted(loadData);
                onBeforeUnmount(() => { if(progressInterval) clearInterval(progressInterval); });

                return { movie, resources, currentSource };
            }
        }).mount('#app');
    </script>
</body>
</html>
